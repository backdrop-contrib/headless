language: php
dist: xenial
php:
  - 7.2
cache:
  directories:
    - $HOME/.composer/cache/files
    - $HOME/.composer/cache/repo
services:
  - mysql
addons:
  - mariadb: '10.3'
before_install:
  # Install Apache and FastCGI extension to connect to PHP-FPM.
  - sudo apt-get update > /dev/null
  - sudo apt-get install apache2 libapache2-mod-fastcgi > /dev/null
  - sudo a2enmod rewrite actions fastcgi alias
  - sudo cp -f /home/travis/build/backdrop-contrib/headless/tests/misc/vhost.conf /etc/apache2/sites-available/000-default.conf
    #- sudo sed -i -e "s,/home/travis/web,`pwd`,g" /etc/apache2/sites-available/default
  - sudo apachectl restart

  # Start PHP-FPM. There is no process manager available to start PHP-FPM on
  # Travis CI currently, so we have to locate and enable it manually.
  - sudo cp $HOME/.phpenv/versions/`php -r "print PHP_VERSION;"`/etc/php-fpm.conf.default $HOME/.phpenv/versions/`php -r "print PHP_VERSION;"`/etc/php-fpm.conf
  - $HOME/.phpenv/versions/`php -r "print PHP_VERSION;"`/sbin/php-fpm

  # Get Backdrop and the Drushies.
  - sudo rm -rf /var/www/html/*
  - groups
  - sudo chown travis:travis -R /var/www
  - git clone https://github.com/backdrop/backdrop /var/www/html
  - git clone https://github.com/drush-ops/drush /var/www/html/drush
  - git clone https://github.com/backdrop-contrib/backdrop-drush-extension /var/www/html/drush/commands/backdrop
  - cd /var/www/html/drush && git checkout 8.x && composer install
  - sudo ln -s /var/www/html/drush/drush /usr/local/bin/drush
  - mysql -e "drop database if exists backdrop"
  - mysql -e "create database backdrop"
  - cd /var/www/html
  - cp -a /home/travis/build/backdrop-contrib/headless /var/www/html/modules/headless
  - drush si --db-url=mysql://root:@127.0.0.1/backdrop
  - drush en headless -y
  - drush en simpletest -y

script:
  # Check code standards
  - cd /home/travis/build/backdrop-contrib/headless
  - composer install
  - >
    vendor/bin/phpcs -n
    --standard=vendor/backdrop/coder/coder_sniffer/Backdrop
    --ignore="vendor/*,README.md"
    --extensions=install,module,php,inc,theme,test .

  # Simpletests
    #- sudo chown travis:www-data -R /home/travis/web
    #- chmod 2775 -R /home/travis/web
  - curl http://127.0.0.1
  - curl http://127.0.0.1/user/login
  - ls -alh /var
  - ls -alh /var/www
  - ls -alh /var/www/html
    #- >
    #  php -d
    #  display_errors="stderr"
    #  ./core/scripts/run-tests.sh
    #  --concurrency 12
    #  --url 'http://127.0.0.1'
    #  --color
    #  --verbose
    #  --force
    #  BackdropHeadlessTestCase

